---
title: "SQL Segment Validation Rules"
description: "SQL validation rules and constraints for creating segments with SQL expressions in Data 360"
---

# SQL Segment Validation Rules

When creating or updating segments using SQL expressions, your queries must comply with these validation rules. These constraints ensure segments can be properly processed and activated.

## Overview

SQL-based segments use the `sql` property in segment definitions. The SQL must select unified profile identifiers that define segment membership.

```json segment_definition.json {3-4}
{
  "name": "High_Value_Customers",
  "displayName": "High Value Customers",
  "sql": "SELECT Id__c FROM UnifiedIndividual__dlm WHERE LifetimeValue__c > 1000"
}
```

## SELECT Statement Rules

### Primary Key Only

The SELECT clause must contain **only the primary key** of the target Data Model Object (DMO):

<CodeGroup>
```sql valid_primary_key.sql icon=check {1}
SELECT Id__c
FROM UnifiedIndividual__dlm
WHERE LifetimeValue__c > 1000
```

```sql invalid_multiple_columns.sql icon=xmark {1}
-- INVALID: Multiple columns not allowed
SELECT Id__c, FirstName__c, Email__c
FROM UnifiedIndividual__dlm
```
</CodeGroup>

### No Aggregation Functions

Top-level SELECT statements cannot include aggregation functions:

```sql invalid_aggregations.sql icon=xmark {2-4}
-- INVALID: Aggregation functions not allowed at top level
SELECT MAX(Id__c) FROM UnifiedIndividual__dlm
SELECT COUNT(Id__c) FROM UnifiedIndividual__dlm
SELECT AVG(LifetimeValue__c) FROM UnifiedIndividual__dlm
```

<Note>
Aggregation functions can be used in subqueries within the WHERE clause.
</Note>

### No Wildcards

Wildcard expressions (`*`) are not permitted:

```sql invalid_wildcard.sql icon=xmark {2}
-- INVALID: Wildcards not allowed
SELECT * FROM UnifiedIndividual__dlm
```

### No Case Statements

Case statements are not allowed in the primary SELECT:

```sql invalid_case.sql icon=xmark {2-3}
-- INVALID: CASE statements not allowed
SELECT CASE WHEN Active__c THEN Id__c ELSE NULL END
FROM UnifiedIndividual__dlm
```

### No Column Aliases

Columns in the SELECT clause cannot be aliased:

```sql invalid_alias.sql icon=xmark {2-3}
-- INVALID: Column aliases not allowed
SELECT Id__c AS ProfileId
FROM UnifiedIndividual__dlm
```

## Key Qualifier Requirements

When the primary key includes key qualifiers, **both the key and qualifiers must be projected**:

```sql key_qualifiers.sql icon=check {1-2,4}
SELECT Id__c, DataSource__c
FROM UnifiedIndividual__dlm
WHERE Region__c = 'West'
GROUP BY Id__c, DataSource__c
```

The key and qualifiers must also be included in the GROUP BY clause when present.

## JOIN Rules

### Fully Qualified Column Names

All columns in JOIN queries must include the table name or alias:

<CodeGroup>
```sql valid_qualified.sql icon=check {1,4}
SELECT ui.Id__c
FROM UnifiedIndividual__dlm ui
JOIN UnifiedContactPointEmail__dlm cpe ON ui.Id__c = cpe.PartyId__c
WHERE ui.Region__c = 'West'
```

```sql invalid_unqualified.sql icon=xmark {2,4}
-- INVALID: Columns must be qualified
SELECT Id__c
FROM UnifiedIndividual__dlm ui
JOIN UnifiedContactPointEmail__dlm cpe ON Id__c = PartyId__c
```
</CodeGroup>

### Relationship Requirements

JOINs must use established relationships between DMOs:

- A relationship must exist between the joined tables
- Join conditions must use the related join keys
- Only equality comparisons (`=`) are allowed in join conditions

```sql valid_relationship.sql icon=check {3-4}
SELECT ui.Id__c
FROM UnifiedIndividual__dlm ui
JOIN UnifiedContactPointEmail__dlm cpe
  ON ui.Id__c = cpe.PartyId__c  -- Valid relationship key
WHERE cpe.IsPrimary__c = true
```

### Profile Table First

The first table in the FROM clause must be a **profile DMO**:

<CodeGroup>
```sql valid_profile_first.sql icon=check {2}
SELECT ui.Id__c
FROM UnifiedIndividual__dlm ui  -- Profile DMO first
JOIN SalesData__dlm sd ON ui.Id__c = sd.CustomerId__c
```

```sql invalid_non_profile_first.sql icon=xmark {2}
-- INVALID: Non-profile table first
FROM SalesData__dlm sd  -- Not a profile DMO
JOIN UnifiedIndividual__dlm ui ON sd.CustomerId__c = ui.Id__c
```
</CodeGroup>

## Subquery Rules

### WHERE Clause Only

Subqueries are only allowed in the WHERE clause:

<CodeGroup>
```sql valid_subquery_where.sql icon=check {3-7}
SELECT Id__c
FROM UnifiedIndividual__dlm
WHERE Id__c IN (
  SELECT PartyId__c
  FROM UnifiedContactPointEmail__dlm
  WHERE Domain__c = 'enterprise.com'
)
```

```sql invalid_subquery_select.sql icon=xmark {2}
-- INVALID: Subquery in SELECT not allowed
SELECT (SELECT COUNT(*) FROM Orders__dlm WHERE CustomerId__c = ui.Id__c)
FROM UnifiedIndividual__dlm ui
```
</CodeGroup>

### Single Column Output

Subqueries must return a single column:

<CodeGroup>
```sql valid_single_column.sql icon=check {2}
-- Valid: Single column in subquery
WHERE Id__c IN (SELECT PartyId__c FROM UnifiedContactPointEmail__dlm)
```

```sql invalid_multiple_columns_sub.sql icon=xmark {2}
-- INVALID: Multiple columns in subquery
WHERE (Id__c, Region__c) IN (SELECT PartyId__c, Region__c FROM ...)
```
</CodeGroup>

## Data Type Rules

### Type Matching

Column data types must match in comparisons:

<CodeGroup>
```sql valid_type_matching.sql icon=check {2-4}
-- Valid: Matching data types
WHERE Age__c > 25                          -- Numeric comparison
WHERE Email__c = 'john@example.com'        -- String comparison
WHERE CreatedDate__c > '2024-01-01'        -- Date comparison
```

```sql invalid_type_mismatch.sql icon=xmark {2}
-- INVALID: Type mismatch
WHERE Age__c = 'twenty-five'  -- Number compared to string
```
</CodeGroup>

## Supported Clauses

### LIMIT and OFFSET

Both LIMIT and OFFSET are supported for result pagination:

```sql pagination.sql icon=check {4-5}
SELECT Id__c
FROM UnifiedIndividual__dlm
WHERE IsActive__c = true
LIMIT 10000
OFFSET 5000
```

## Prohibited Operations

The following are **not allowed** in segment SQL:

| Operation | Example | Reason |
|-----------|---------|--------|
| Non-SELECT statements | `UPDATE`, `INSERT`, `DELETE` | Segments are read-only |
| DDL statements | `CREATE TABLE`, `ALTER` | Schema modifications not allowed |
| Multiple statements | `SELECT...; SELECT...` | Single query only |
| Non-DMO tables | `SELECT * FROM CustomTable` | Must use DMO objects |

## Table Aliases

Only DMO table aliases are permitted. Column aliases are not allowed:

<CodeGroup>
```sql valid_table_alias.sql icon=check {2-3}
SELECT ui.Id__c
FROM UnifiedIndividual__dlm ui
WHERE ui.IsActive__c = true
```

```sql invalid_column_alias.sql icon=xmark {2-3}
-- INVALID: Column alias not allowed
SELECT ui.Id__c AS ProfileIdentifier
FROM UnifiedIndividual__dlm ui
```
</CodeGroup>

## Validation Error Messages

Common validation errors and solutions:

| Error | Cause | Solution |
|-------|-------|----------|
| `INVALID_SELECT_EXPRESSION` | Multiple columns or aggregates | Select only primary key |
| `INVALID_JOIN_CONDITION` | Non-equality or unrelated tables | Use `=` with related keys |
| `INVALID_TABLE_ORDER` | Non-profile table first | Put profile DMO in FROM |
| `INVALID_SUBQUERY` | Subquery outside WHERE | Move subquery to WHERE clause |
| `TYPE_MISMATCH` | Incompatible comparison types | Match data types |

## Complete Examples

### Simple Segment

```sql simple_segment.sql icon=database {1-3}
SELECT Id__c
FROM UnifiedIndividual__dlm
WHERE Region__c = 'West' AND IsActive__c = true
```

### Segment with JOIN

```sql segment_with_join.sql icon=database {1-5}
SELECT ui.Id__c
FROM UnifiedIndividual__dlm ui
JOIN UnifiedContactPointEmail__dlm cpe
  ON ui.Id__c = cpe.PartyId__c
WHERE cpe.IsVerified__c = true
```

### Segment with Subquery

```sql segment_with_subquery.sql icon=database {3-7}
SELECT Id__c
FROM UnifiedIndividual__dlm
WHERE Id__c IN (
  SELECT PartyId__c
  FROM PurchaseHistory__dlm
  WHERE PurchaseDate__c > '2024-01-01'
)
```

### Segment with Key Qualifiers

```sql segment_with_qualifiers.sql icon=database {1-2,4}
SELECT Id__c, DataSource__c
FROM UnifiedIndividual__dlm
WHERE LifetimeValue__c > 500
GROUP BY Id__c, DataSource__c
```

## Related Resources

- [Segments API](/apis/connect-api/segments) - Create and manage segments
- [Segment Metadata Type](/apis/metadata-types/segments) - Deploy segment definitions
- [SQL Reference](/apis/query-api/sql-reference) - Data 360 SQL syntax
